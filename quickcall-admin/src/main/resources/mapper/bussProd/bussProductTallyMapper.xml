<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="BussProductTally">

	<resultMap type="BussProductTally" id="bussProductTallyMap">
		<id property="id" column="id" javaType="java.lang.String"></id>
		<result property="prodId" column="prod_id" javaType="java.lang.String"></result>
		<result property="companyId" column="company_id" javaType="java.lang.String"></result>
		<result property="tallyDate" column="tally_date" javaType="java.util.Date"></result>
		<result property="cpa" column="cpa" ></result>
		<result property="uv" column="uv" javaType="java.lang.Long"></result>
		<result property="percent" column="percent" javaType="java.math.BigDecimal"></result>
		<result property="registCount" column="regist_count" javaType="java.lang.Long"></result>
		<result property="tallyAmount" column="tally_amount" javaType="java.math.BigDecimal"></result>
		<result property="tallyer" column="tallyer" javaType="java.lang.String"></result>
		<result property="expectCount" column="expect_count" javaType="java.lang.Integer"></result>
		<result property="createMan" column="create_man" javaType="java.lang.String"></result>
		<result property="modifyMan" column="modify_man" javaType="java.lang.String"></result>
		<result property="createTime" column="create_time" javaType="java.util.Date"></result>
		<result property="modifyTime" column="modify_time" javaType="java.util.Date"></result>
	</resultMap>

	<!-- 通用查询结果列-->
	<sql id="Base_Column_List">
id,	prod_id,	company_id,	tally_date,	cpa,uv,	percent,regist_count,	tally_amount,	tallyer,expect_count,	create_man,	modify_man,	create_time,	modify_time
	</sql>

	<!-- 查询（根据主键ID查询） -->
	<select id="getEntityById" resultMap="bussProductTallyMap" parameterType="java.lang.String">
		 SELECT
		 <include refid="Base_Column_List" />
		 FROM buss_product_tally
		 WHERE id = #{id}
	</select>

	<!-- 查询（根据主键ID查询） -->
	<select id="findAll" resultMap="bussProductTallyMap" parameterType="java.lang.String">
		 SELECT
		 <include refid="Base_Column_List" />
		 FROM buss_product_tally
		 WHERE id = #{id}
	</select>

	<!--删除：根据主键ID删除-->
	<delete id="deleteEntity" parameterType="java.lang.String">
		 DELETE FROM buss_product_tally
		 WHERE id = #{arg0}
	</delete>

	<!-- 添加 -->
	<insert id="saveEntity" parameterType="com.calf.module.bussiness.entity.BussProductTally">
		 INSERT INTO buss_product_tally
 		(id,prod_id,company_id,tally_date,cpa,uv,percent,regist_count,tally_amount,tallyer,expect_count,create_man,modify_man,create_time,modify_time)
		 VALUES 
 		(#{id},#{prodId},#{companyId},#{tallyDate},#{cpa},#{uv},#{percent},#{registCount},#{tallyAmount},#{tallyer},#{expectCount},#{createMan},#{modifyMan},#{createTime},#{modifyTime})
	</insert>
	<!-- 添加 -->
	<insert id="insert" parameterType="com.calf.module.bussiness.entity.BussProductTally">
		 INSERT INTO buss_product_tally
 		(id,prod_id,company_id,tally_date,cpa,uv,percent,regist_count,tally_amount,tallyer,expect_count,create_man,modify_man,create_time,modify_time)
		 VALUES 
 		(#{id},#{prodId},#{companyId},#{tallyDate},#{cpa},#{uv},#{percent},#{registCount},#{tallyAmount},#{tallyer},#{expectCount},#{createMan},#{modifyMan},#{createTime},#{modifyTime})
	</insert>

	<!-- 修 改-->
	<update id="updateEntity" parameterType="com.calf.module.bussiness.entity.BussProductTally">
		 UPDATE buss_product_tally
 		 <set> 
			<if test="prodId != null">
				 prod_id = #{prodId},
			</if>
			<if test="tallyDate != null">
				 tally_date = #{tallyDate},
			</if>
			<if test="cpa != null">
				 cpa = #{cpa},
			</if>
			<if test="uv != null">
				 uv = #{uv},
			</if>
			<if test="percent != null">
				 percent = #{percent},
			</if>
			<if test="registCount != null">
				 regist_count = #{registCount},
			</if>
			<if test="tallyAmount != null">
				 tally_amount = #{tallyAmount},
			</if>
			<if test="tallyer != null">
				 tallyer = #{tallyer},
			</if>
			<if test="expectCount != null">
				 expect_count = #{expectCount},
			</if>
			<if test="createMan != null">
				 create_man = #{createMan},
			</if>
			<if test="modifyMan != null">
				 modify_man = #{modifyMan},
			</if>
			<if test="createTime != null">
				 create_time = #{createTime},
			</if>
			<if test="modifyTime != null">
				 modify_time = #{modifyTime},
			</if>

 		 </set>
		 WHERE id = #{id}
	</update>
	
	
	<!-- 修 改-->
	<update id="updateEntityExt" parameterType="map">
		 UPDATE 
		 	buss_product_tally
 		 set 
		 cpa = #{cpa},
		 uv = #{uv},
		 percent = #{percent},
		 tally_date = #{tallyDate},
		 regist_count = #{registCount},
		 tally_amount = #{tallyAmount},
		 expect_count = #{expectCount},
		 modify_man = #{modifyMan},
		 modify_time = #{modifyTime},
		 tallyer = #{tallyer}
		 WHERE id = #{id}
	</update>
   
   <select id="query" parameterType="Map" resultMap="bussProductTallyMap">
		  SELECT
			bp.product_name productName,
           <!--  p.sort  sort,
            p.is_recommend isRecommend, -->
            bp.company_name as  companyName,
			bpt.*,
			date(bpt.tally_date) tallyTime
		FROM
			<!-- product p
		INNER JOIN  -->buss_product_tally bpt 
		LEFT  JOIN  buss_product  bp  on  bpt.prod_id = bp.product_id
		
		where 1=1

		<if test="productName!=null and productName!=''">
		and bp.product_name like concat('%',#{productName},'%')
		</if>
		<if test="productId!=null and productId!=''">
		and bp.product_id = #{productId}
		</if>
		<if test="tallyer!=null and tallyer!=''">
		and  bpt.tallyer =#{tallyer}
		</if>
		<if test="stallyDate!=null and stallyDate!=''">
		and date(bpt.tally_date) &gt;= #{stallyDate}
		</if>
		<if test="etallyDate!=null and etallyDate!=''">
		and date(bpt.tally_date) &lt;= #{etallyDate}
		</if>
		<if test="createMan!=null and createMan!=''">
	     and bpt.create_man=#{createMan}
	    </if>
		order by bpt.create_time  desc
		 <if test="exportflag==null">
			LIMIT  #{iDisplayStart},#{iDisplayLength}
		</if>
   </select>
   
   
   <select id="queryCount" parameterType="Map" resultType="int">
		  SELECT
			count(bpt.id)
		FROM
			<!-- product p
		INNER JOIN --> buss_product_tally bpt LEFT  JOIN  buss_product  bp  on bpt.prod_id =  bp.product_id
		where 1=1
		<if test="productName!=null and productName!=''">
		and bp.product_name like concat('%',#{productName},'%')
		</if>
		<if test="productId!=null and productId!=''">
		and bp.product_id = #{productId}
		</if>
		<if test="tallyer!=null and tallyer!=''">
		and  bpt.tallyer =#{tallyer}
		</if>
		<if test="stallyDate!=null and stallyDate!=''">
		and date(bpt.tally_date) &gt;= #{stallyDate}
		</if>
		<if test="etallyDate!=null and etallyDate!=''">
		and date(bpt.tally_date) &lt;= #{etallyDate}
		</if>
		<if test="createMan!=null and createMan!=''">
	     and bpt.create_man=#{createMan}
	    </if>
	    
   </select>


	<select id="sumTally" parameterType="Map" resultMap="bussProductTallyMap">
		SELECT
			sum(tally_amount)/sum(regist_count) cpa ,sum(regist_count) regist_count,sum(tally_amount) tally_amount,
			sum(bpt.uv) uv, ROUND(sum(regist_count)/sum(bpt.uv)*100,2) percent,sum(expect_count)  expectCount,ROUND((sum(regist_count)*100)/sum(expect_count),2) manzuStr
		FROM
			<!-- product p
		INNER JOIN --> buss_product_tally bpt  LEFT  JOIN  buss_product  bp  on bpt.prod_id =  bp.product_id
		where 1=1
		<if test="productName!=null and productName!=''">
		and bp.product_name like concat('%',#{productName},'%')
		</if>
		<if test="productId!=null and productId!=''">
		and bp.product_id = #{productId}
		</if>
		<if test="tallyer!=null and tallyer!=''">
		and  bpt.tallyer =#{tallyer}
		</if>
		<if test="stallyDate!=null and stallyDate!=''">
		and date(bpt.tally_date) &gt;= #{stallyDate}
		</if>
		<if test="etallyDate!=null and etallyDate!=''">
		and date(bpt.tally_date) &lt;= #{etallyDate}
		</if>
		<if test="createMan!=null and createMan!=''">
	     and bpt.create_man=#{createMan}
	    </if>
	</select>
	
	
	<!-- 循环插入值 -->
	<insert id="batchInsert" parameterType="map">
		INSERT INTO buss_product_tally
		(id,prod_id,company_id,tally_date,cpa,uv,percent,regist_count,tally_amount,tallyer,expect_count,create_man,modify_man,create_time,modify_time) 
		 VALUES 
		<foreach collection="list" index="index" item="item" separator=",">
 		(#{item.id},#{item.prodId},#{item.companyId},#{item.tallyDate},#{item.cpa},#{item.uv},#{item.percent},#{item.registCount},#{item.tallyAmount},#{item.tallyer},#{item.expectCount},#{item.createMan},#{item.modifyMan},#{item.createTime},#{item.modifyTime})
		</foreach>
	</insert>

	<select id="queryOneById" parameterType="Map" resultMap="bussProductTallyMap">
		SELECT
			p.product_name productName,
			p.company_name companyName,
			bpt.*,
			date(bpt.tally_date) tallyTime

		FROM
			buss_product p
		INNER JOIN buss_product_tally bpt ON p.id = bpt.company_id
		where bpt.id=#{arg0}

	</select>
	<select id="getAllTallyAmount" parameterType="map" resultType="string">
		SELECT
		sum(t.tally_amount)
		FROM buss_product_tally t
		WHERE t.company_id =#{arg0}
	</select>
	<!-- 查询（根据主键ID查询） -->
	<select id="queryTallyByCompanyId" resultMap="bussProductTallyMap" parameterType="java.util.Map">
		SELECT
		<include refid="Base_Column_List" />
		FROM buss_product_tally
		WHERE company_id = #{companyId}
	</select>
	<!-- 查询（根据主键ID查询） -->
	<select id="queryTallyByProductIdTallyDate" resultType="java.lang.String" parameterType="java.util.Map">
		SELECT
			bpt.str
		FROM
			(
				SELECT
					CONCAT(prod_id, tally_date) AS str,
					prod_id,
					tally_date
				FROM
					buss_product_tally
				WHERE
					create_time > #{startTimeStr}
			) bpt
		WHERE
			bpt.str IN 
			<foreach collection="list" item="str"  open="(" close=")" separator=",">
			     #{str}
			</foreach>
	</select>
</mapper>