<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ArrondiDetail">
    <resultMap id="resultMap" type="ArrondiDetail">
        <result property="phoneNum" column="phone_num" />
        <result property="count" column="count" />
        <result property="date" column="date" />
        <result property="applyCount" column="apply_count" />
        <result property="total" column="total" />
        <result property="listCount" column="list_count" />
    </resultMap>

    <select id="queryAll" parameterType="map" resultMap="resultMap">
        SELECT
        a.uid AS phone_num,
         COUNT(0) AS count,
        DATE_FORMAT(
        a.track_time,
        '%Y-%m-%d %H:%i:%s'
        ) AS date
        FROM
            `stat_tracker_his` a
        WHERE 1=1
            and  a.area_id =  1
        <if test="id != null">
            and  a.page_id =  #{id}
        </if>
        <if test="date != null">
            and DATE_FORMAT(a.track_time , '%Y-%m-%d') = #{date}
        </if>
        GROUP BY
            a.uid
        ORDER BY count DESC
    </select>

    <select id="query" parameterType="map" resultMap="resultMap">
        SELECT
            a.uid AS phone_num,
            COUNT(
                CASE
                WHEN (a.area_index = 0 OR a.area_index = 1) THEN
                    0
                END
            ) AS total,
            COUNT(
            CASE
            WHEN (a.page_type_code = 'xulu://more.guanjia.com') THEN
            0
            END
            ) AS list_count,
            COUNT(
                CASE
                WHEN a.area_index = 0 THEN
                    0
                END
            ) AS count,
            COUNT(
                CASE
                WHEN a.area_index = 1 THEN
                    0
                END
            ) AS apply_count,
            DATE_FORMAT(
                a.track_time,
                '%Y-%m-%d %H:%i:%s'
            ) AS date
        FROM
            `stat_tracker_his` a
        WHERE 1=1
        and  a.area_id =  2
        <if test="id != null">
            and  a.page_id =  #{id}
        </if>
        <if test="date != null">
            and DATE_FORMAT(a.track_time , '%Y-%m-%d') = #{date}
        </if>
        GROUP BY
            a.uid
        ORDER BY total DESC
    </select>

</mapper>
