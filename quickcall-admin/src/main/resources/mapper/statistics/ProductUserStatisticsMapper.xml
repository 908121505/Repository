<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ProductUserStatistics">
	<resultMap id="resultMap" type="ProductUserStatistics">
		<result property="productName" column="product_name" />
		<result property="labelName" column="label_name" />
		<result property="parentId" column="parent_id" />
		<result property="clickCount" column="click_count" />
		<result property="applyCount" column="apply_count" />
		<result property="date" column="date" />
		<result property="productId" column="product_id" />
	</resultMap>

	<select id="queryCount" parameterType="map" resultType="Integer">
		SELECT
		COUNT(0)
		FROM
		(
		SELECT
		COUNT(a.track_time)
		FROM
		`stat_tracker_his` a
		INNER JOIN product b ON a.page_id = b.product_id
		WHERE 1=1
		<if test="sDate != null">
			and DATE_FORMAT(a.track_time , '%Y-%m-%d') &gt;= #{sDate}
		</if>
		<if test="eDate != null">
			and DATE_FORMAT(a.track_time , '%Y-%m-%d') &lt;= #{eDate}
		</if>
		GROUP BY
		DATE_FORMAT(a.track_time, '%Y-%m-%d'),
		a.page_id
		) AS c
	</select>

	<select id="query" parameterType="map" resultMap="resultMap">
		SELECT
		DATE_FORMAT(
		a.track_time,
		'%Y-%m-%d %H:%i:%s'
		) AS date,
		b.product_name AS product_name,
		b.product_id AS product_id,
		b.product_category_id AS product_category_id,
		COUNT(
		CASE
		WHEN (
		a.area_id = 2
		AND a.area_index = 1
		) THEN
		0
		END
		) AS apply_count,
		COUNT(
		CASE
		WHEN (
		a.area_id = 2
		AND a.area_index = 0
		) THEN
		0
		END
		) AS click_count
		FROM
		`stat_tracker_his` a
		INNER JOIN product b ON a.page_id = b.product_id
		WHERE 1=1 and b.product_category_id in (SELECT m.product_category_id from
		product_label m)
		<if test="sDate != null">
			and DATE_FORMAT(a.track_time , '%Y-%m-%d') &gt;= #{sDate}
		</if>
		<if test="eDate != null">
			and DATE_FORMAT(a.track_time , '%Y-%m-%d') &lt;= #{eDate}
		</if>
		GROUP BY
		DATE_FORMAT(a.track_time, '%Y-%m-%d'),
		a.page_id
		ORDER BY
		a.track_time DESC
		LIMIT ${iDisplayStart}, ${iDisplayLength}
	</select>

	<select id="queryAll" parameterType="map" resultMap="resultMap">
		SELECT
		DATE_FORMAT(
		a.track_time,
		'%Y-%m-%d %H:%i:%s'
		) AS date,
		b.product_name AS product_name,
		b.product_id AS product_id,
		b.product_category_id AS product_category_id,
		COUNT(
		CASE
		WHEN (
		a.area_id = 2
		AND a.area_index = 1
		) THEN
		0
		END
		) AS apply_count,
		COUNT(
		CASE
		WHEN (
		a.area_id = 2
		AND a.area_index = 0
		) THEN
		0
		END
		) AS click_count
		FROM
		`stat_tracker_his` a
		INNER JOIN product b ON a.page_id = b.product_id
		WHERE 1=1 and b.product_category_id in (SELECT m.product_category_id from
		product_label m)
		<if test="sDate != null">
			and DATE_FORMAT(a.track_time , '%Y-%m-%d') &gt;= #{sDate}
		</if>
		<if test="eDate != null">
			and DATE_FORMAT(a.track_time , '%Y-%m-%d') &lt;= #{eDate}
		</if>
		GROUP BY
		DATE_FORMAT(a.track_time, '%Y-%m-%d'),
		a.page_id
		ORDER BY
		a.track_time DESC
	</select>
	<select id="queryProductByIds" parameterType="map" resultMap="resultMap">
		SELECT a.label_name as labelName,a.parent_id as
		parentId,a.product_category_id as
		productCategoryId,
		ad.product_id as productId,
		ad.product_name as productName
		FROM
		product_label a
		LEFT JOIN product ad ON a.product_category_id =
		ad.product_category_id WHERE
		ad.`product_id` IN
		<if test="ids !=null and ids.size>0">
			<foreach item="item" index="index" collection="ids" open="("
				separator="," close=")">
				#{item}
			</foreach>
		</if>


	</select>
</mapper>
