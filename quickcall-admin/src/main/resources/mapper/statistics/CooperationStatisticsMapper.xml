<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="CooperationStatistics">
    <resultMap id="resultMap" type="CooperationStatistics">
        <result property="productName" column="product_name" />
        <result property="clickCount" column="click_count" />
        <result property="applyCount" column="apply_count" />
        <result property="date" column="date" />
        <result property="productId" column="product_id" />
        <result property="users" column="users" />
        <result property="listCount" column="list_count" />
        <result property="total" column="total" />
        <result property="position" column="position" />
        <result property="postCount" column="post_count" />
         <result property="uid" column="uid" />
         <result property="areaIndex" column="area_index" />
         <result property="pageTypeCode" column="page_type_code" />
         <result property="areaId" column="area_id" />
    </resultMap>

    <select id="queryCount" parameterType="map" resultType="Integer">
        SELECT
        COUNT(0)
        FROM
        (
        SELECT
        COUNT(a.track_time)
        FROM
        `stat_tracker_his` a
        INNER JOIN product b ON a.page_id = b.product_id
        WHERE 1=1
        <if test="sDate != null">
            and DATE_FORMAT(a.track_time , '%Y-%m-%d') &gt;=  #{sDate}
        </if>
        <if test="eDate != null">
            and DATE_FORMAT(a.track_time , '%Y-%m-%d') &lt;=  #{eDate}
        </if>
        <if test="name != null">
            and b.product_name like concat('%', #{name},'%')
        </if>
        GROUP BY
        DATE_FORMAT(a.track_time, '%Y-%m-%d'),
        a.page_id
        ) AS c
    </select>

    <select id="query" parameterType="map" resultMap="resultMap">
       SELECT * FROM ( SELECT
            b.product_name AS product_name,
            b.product_id AS product_id,
            b.sort AS position,
            DATE_FORMAT(
                a.track_time,
                '%Y-%m-%d'
            ) AS date,
            COUNT(DISTINCT a.uid) AS users,
            COUNT(
                CASE
                WHEN a.area_id = 2 THEN
                    0
                END
            ) AS total,
            COUNT(
                CASE
                WHEN (
                    a.area_id = 2
                    AND a.area_index = 1
                ) THEN
                    0
                END
            ) AS apply_count,
            COUNT(
                CASE
                WHEN (
                    a.area_id = 2
                    AND a.area_index = 0
                ) THEN
                    0
                END
            ) AS click_count,
             COUNT(
		        CASE
		        WHEN (
		        a.area_id = 2
		        AND a.area_index = 3
		        ) THEN
		        0
		        END
		        ) AS post_count,
            COUNT(
            CASE
            WHEN (
            a.area_id = 2
            AND a.page_type_code = 'xulu://more.guanjia.com'
            ) THEN
            0
            END
            ) AS list_count
        FROM
            `stat_tracker_his` a
        INNER JOIN product b ON a.page_id = b.product_id
        WHERE 1=1
        <if test="sDate != null">
            and DATE_FORMAT(a.track_time , '%Y-%m-%d') &gt;=  #{sDate}
        </if>
        <if test="eDate != null">
            and DATE_FORMAT(a.track_time , '%Y-%m-%d') &lt;=  #{eDate}
        </if>
        <if test="name != null">
            and b.product_name like concat('%', #{name},'%')
        </if>
        GROUP BY
            DATE_FORMAT(a.track_time, '%Y-%m-%d'),
            a.page_id ) t
          ORDER BY
              t.date DESC, t.click_count  DESC
        LIMIT ${iDisplayStart}, ${iDisplayLength}
    </select>

    <select id="queryAll" parameterType="map" resultMap="resultMap">
        SELECT
        b.product_name AS product_name,
        b.product_id AS product_id,
        b.sort AS position,
        DATE_FORMAT(
        a.track_time,
        '%Y-%m-%d'
        ) AS date,
        COUNT(DISTINCT a.uid) AS users,
        COUNT(
        CASE
        WHEN a.area_id = 2 THEN
        0
        END
        ) AS total,
        COUNT(
        CASE
        WHEN (
        a.area_id = 2
        AND a.area_index = 1
        ) THEN
        0
        END
        ) AS apply_count,
        COUNT(
        CASE
        WHEN (
        a.area_id = 2
        AND a.area_index = 0
        ) THEN
        0
        END
        ) AS click_count,
         COUNT(
        CASE
        WHEN (
        a.area_id = 2
        AND a.area_index = 3
        ) THEN
        0
        END
        ) AS post_count,
        COUNT(
        CASE
        WHEN (
        a.area_id = 2
        AND a.page_type_code = 'xulu://more.guanjia.com'
        ) THEN
        0
        END
        ) AS list_count
        FROM
        `stat_tracker_his` a
        INNER JOIN product b ON a.page_id = b.product_id
        WHERE 1=1
        <if test="sDate != null">
            and DATE_FORMAT(a.track_time , '%Y-%m-%d') &gt;=  #{sDate}
        </if>
        <if test="eDate != null">
            and DATE_FORMAT(a.track_time , '%Y-%m-%d') &lt;=  #{eDate}
        </if>
        <if test="name != null">
            and b.product_name like concat('%', #{name},'%')
        </if>
        GROUP BY
        DATE_FORMAT(a.track_time, '%Y-%m-%d'),
        a.page_id
<!--         ORDER BY a.track_time DESC -->
    </select>
    
  <!--     <select id="queryOut" parameterType="map" resultMap="resultMap">
        SELECT
        b.product_name AS product_name,
        b.product_id AS product_id,
        b.sort AS position,
        DATE_FORMAT(a.track_time,'%Y-%m-%d %H:%i:%s') AS date,
        a.uid,
        a.area_index,
        a.page_type_code,
        a.area_id    
        FROM
        `stat_tracker_his` a
        INNER JOIN product b ON a.page_id = b.product_id
        WHERE 1=1
        AND TO_DAYS( NOW( ) ) - TO_DAYS(track_time) = 1
        ORDER BY
        a.track_time 
    </select> -->
    
      <select id="queryOut" parameterType="map" resultMap="resultMap">
        SELECT * FROM ( SELECT
            b.product_name AS product_name,
            b.product_id AS product_id,
            b.sort AS position,
            DATE_FORMAT(
                a.track_time,
                '%Y-%m-%d'
            ) AS date,
            COUNT(DISTINCT a.uid) AS users,
            COUNT(
                CASE
                WHEN a.area_id = 2 THEN
                    0
                END
            ) AS total,
            COUNT(
                CASE
                WHEN (
                    a.area_id = 2
                    AND a.area_index = 1
                ) THEN
                    0
                END
            ) AS apply_count,
            COUNT(
                CASE
                WHEN (
                    a.area_id = 2
                    AND a.area_index = 0
                ) THEN
                    0
                END
            ) AS click_count,
             COUNT(
		        CASE
		        WHEN (
		        a.area_id = 2
		        AND a.area_index = 3
		        ) THEN
		        0
		        END
		        ) AS post_count
		   <!--      ,
            COUNT(
            CASE
            WHEN (
            a.area_id = 2
            AND a.area_index in(15,16)
            ) THEN
            0
            END
            ) AS list_count -->
        FROM
            `stat_tracker_his` a
        INNER JOIN product b ON a.page_id = b.product_id
        WHERE 1=1
         AND TO_DAYS( NOW( ) ) - TO_DAYS(track_time) = 1
        GROUP BY
            DATE_FORMAT(a.track_time, '%Y-%m-%d'),
            a.page_id ) t
<!--           ORDER BY t.date DESC, t.click_count  DESC -->
    </select>
    
    <select id="queryListCount" parameterType="map" resultMap="resultMap">
        SELECT 
        	COUNT(0) as list_count
        FROM 
        	stat_tracker_his 
        where area_id = 2 
        and area_index in(15,16) 
        AND TO_DAYS( NOW( ) ) - TO_DAYS(track_time) = 1 
        GROUP BY DATE_FORMAT(track_time, '%Y-%m-%d')
    </select>
    
 <!--     <select id="queryAllOut" parameterType="map" resultMap="resultMap">
        SELECT
        b.product_name AS product_name,
        b.product_id AS product_id,
        b.sort AS position,
        DATE_FORMAT(a.track_time,'%Y-%m-%d %H:%i:%s') AS date,
        a.uid,
        a.area_index,
        a.page_type_code, 
        a.area_id      
        FROM
        `stat_tracker_his` a
        INNER JOIN product b ON a.page_id = b.product_id
        WHERE 1=1
        ORDER BY
        a.track_time 
    </select> -->
     <select id="queryAllOut" parameterType="map" resultMap="resultMap">
        SELECT
        b.product_name AS product_name,
        b.product_id AS product_id,
        b.sort AS position,
        DATE_FORMAT(
        a.track_time,
        '%Y-%m-%d'
        ) AS date,
        COUNT(DISTINCT a.uid) AS users,
        COUNT(
        CASE
        WHEN a.area_id = 2 THEN
        0
        END
        ) AS total,
        COUNT(
        CASE
        WHEN (
        a.area_id = 2
        AND a.area_index = 1
        ) THEN
        0
        END
        ) AS apply_count,
        COUNT(
        CASE
        WHEN (
        a.area_id = 2
        AND a.area_index = 0
        ) THEN
        0
        END
        ) AS click_count,
         COUNT(
        CASE
        WHEN (
        a.area_id = 2
        AND a.area_index = 3
        ) THEN
        0
        END
        ) AS post_count,
        COUNT(
        CASE
        WHEN (
        a.area_id = 2
        AND a.area_index in(15,16)
        ) THEN
        0
        END
        ) AS list_count
        FROM
        `stat_tracker_his` a
        INNER JOIN product b ON a.page_id = b.product_id
        WHERE 1=1
        GROUP BY
        DATE_FORMAT(a.track_time, '%Y-%m-%d'),
        a.page_id
<!--         ORDER BY a.track_time DESC -->
        <if test="iDisplayStart !=null and iDisplayLength!=null">
        LIMIT ${iDisplayStart}, ${iDisplayLength}
        </if>
    </select>
    

    <select id="queryMoreClick" parameterType="map"  resultMap="resultMap">
        SELECT
            COUNT(0) AS list_count,
            DATE_FORMAT(track_time, '%Y-%m-%d') AS date
        FROM
            `stat_tracker_his`
        WHERE 1=1
          AND page_type_code = 'xulu://more.guanjia.com'
        <if test="sDate != null">
            and DATE_FORMAT(track_time , '%Y-%m-%d') &gt;=  #{sDate}
        </if>
        <if test="eDate != null">
            and DATE_FORMAT(track_time , '%Y-%m-%d') &lt;=  #{eDate}
        </if>
        GROUP BY
            DATE_FORMAT(track_time, '%Y-%m-%d')
    </select>

</mapper>
