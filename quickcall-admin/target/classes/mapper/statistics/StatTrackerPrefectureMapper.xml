<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="StatTrackerPrefecture">
    <resultMap id="resultMap" type="com.calf.module.statistics.entity.StatTrackerPrefecture">
    	<id column="id" property="id" />
        <result property="users" column="users"/>
        <result property="clickCount" column="click_count"/>
        <result property="arrondiCount" column="arrondi_count"/>
        <result property="arrondiId" column="arrondi_id"/>
        <result property="date" column="date"/>
        <result property="name" column="name"/>
        <result property="position" column="position"/>
        <result property="phoneNum" column="phoneNum"/>
        <result property="count" column="count"/>
    </resultMap>
    
    <sql id="Base_Column_List">
    	id,arrondi_id,click_count,users,DATE_FORMAT(track_time,'%Y-%m-%d') as date ,zone_name as name,zone_type as position
    </sql>

    <select id="queryCount" parameterType="map" resultType="Integer">
        SELECT
        COUNT(0)
        FROM
        (
        SELECT
        track_time
        FROM
        stat_tracker_prefecture 
        WHERE 1=1
        <if test="sDate != null">
            and track_time &gt;= #{sDate}
        </if>
        <if test="eDate != null">
            and track_time &lt;= #{eDate}
        </if>
        <if test="name != null">
            and zone_name like concat('%', #{name},'%')
        </if>
        GROUP BY
        arrondi_id,
        DATE_FORMAT(track_time, '%Y-%m-%d')
        )AS a
    </select>
    
    <select id="query" parameterType="map" resultMap="resultMap">
        SELECT
           <include refid="Base_Column_List"></include>
        FROM
            stat_tracker_prefecture 
        WHERE 1=1
        <if test="sDate != null">
            and track_time &gt;= #{sDate}
        </if>
        <if test="eDate != null">
            and track_time &lt;= #{eDate}
        </if>
        <if test="name != null">
            and zone_name like concat('%', #{name},'%')
        </if>
        GROUP BY
        arrondi_id,
        DATE_FORMAT(track_time, '%Y-%m-%d')
        ORDER BY
        track_time DESC
        <if test="iDisplayStart != null and iDisplayLength!=null">
            LIMIT ${iDisplayStart}, ${iDisplayLength}
        </if>       
    </select>
    
    <select id="queryDetail" parameterType="map" resultMap="resultMap">
       SELECT
        uid AS phoneNum,
        COUNT(0) AS count,
        DATE_FORMAT(
        track_time,
        '%Y-%m-%d %H:%i:%s'
        ) AS date
        FROM
            `stat_tracker_prefecture` 
        WHERE 1=1
        <if test="id != null">
           and  page_id =  #{id}
        </if>
        <if test="date != null">
            and DATE_FORMAT(track_time , '%Y-%m-%d') = #{date}
        </if>
        GROUP BY
            uid
        ORDER BY count DESC
    </select>
    
     <insert id="insert" parameterType="com.calf.module.statistics.entity.StatTrackerPrefecture" >
    insert into stat_tracker_prefecture (id, arrondi_id, 
      click_count,users, track_time,zone_name,zone_type)
    values (#{id,jdbcType=INTEGER}, #{arrondiId,jdbcType=VARCHAR}, 
      #{clickCount,jdbcType=INTEGER}, #{users,jdbcType=INTEGER}, #{date,jdbcType=TIMESTAMP}, #{name,jdbcType=VARCHAR}, #{position,jdbcType=INTEGER})
  </insert>

    <select id="queryAll" parameterType="map" resultMap="resultMap">
        SELECT
            <include refid="Base_Column_List"></include>
        FROM
            stat_tracker_prefecture 
        WHERE 1=1
        <if test="sDate != null">
            and DATE_FORMAT(track_time , '%Y-%m-%d') &gt;= #{sDate}
        </if>
        <if test="eDate != null">
            and DATE_FORMAT(track_time , '%Y-%m-%d') &lt;= #{eDate}
        </if>
        <if test="name != null">
            and zone_name like concat('%', #{name},'%')
        </if>
        GROUP BY
        arrondi_id,
        DATE_FORMAT(track_time, '%Y-%m-%d')
        ORDER BY
        track_time DESC
    </select> 
    
       <select id="queryOne" parameterType="map" resultType="Integer">
        SELECT
            1
        FROM
            stat_tracker_prefecture 
        WHERE 1=1
        limit 1
    </select> 

</mapper>
