<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="StatTrackerTerrace">
    <resultMap id="resultMap" type="com.calf.module.statistics.entity.StatTrackerTerrace">
        <result property="productName" column="product_name" />
        <result property="clickCount" column="click_count" />
        <result property="applyCount" column="apply_count" />
        <result property="date" column="date" />
        <result property="productId" column="product_id" />
        <result property="users" column="users" />
        <result property="listCount" column="list_count" />
        <result property="total" column="total" />
        <result property="position" column="position" />
        <result property="postCount" column="post_count" />
        <result property="uid" column="uid" />
        <result property="areaIndex" column="area_index" />
        <result property="pageTypeCode" column="page_type_code" />
        <result property="areaId" column="area_id" />
        <result property="phoneNum" column="phone_num" />
        <result property="count" column="count" />
    </resultMap>
    
    <sql id="Base_Column_List">
    	id,product_name,product_id,sort as position,DATE_FORMAT(track_time,'%Y-%m-%d') AS date ,uid,users,total,apply_count,click_count,post_count,list_count
    </sql>
    
     <insert id="insert" parameterType="com.calf.module.statistics.entity.StatTrackerTerrace" >
    insert into stat_tracker_terrace (id, product_name, product_id,sort,
      track_time, uid,users,total,apply_count,click_count,post_count,list_count)
    values (#{id,jdbcType=INTEGER}, #{productName,jdbcType=VARCHAR}, #{productId,jdbcType=VARCHAR},
      #{position,jdbcType=INTEGER}, #{date,jdbcType=TIMESTAMP}, #{uid,jdbcType=VARCHAR}, #{users,jdbcType=INTEGER}, #{total,jdbcType=INTEGER},
      #{applyCount,jdbcType=INTEGER},#{clickCount,jdbcType=INTEGER},#{postCount,jdbcType=INTEGER},#{listCount,jdbcType=INTEGER})
  </insert>
  

    <select id="queryCount" parameterType="map" resultType="Integer">
        SELECT
        COUNT(0)
        FROM
        (
        SELECT
        id
        FROM
        `stat_tracker_terrace` 
        WHERE 1=1
        <if test="sDate != null">
            and track_time &gt;=  #{sDate}
        </if>
        <if test="eDate != null">
            and track_time &lt;=  #{eDate}
        </if>
        <if test="name != null">
            and product_name like concat('%', #{name},'%')
        </if>
        ) AS c
    </select>

    <select id="query" parameterType="map" resultMap="resultMap">
       SELECT * FROM ( SELECT
        <include refid="Base_Column_List"></include>
        FROM
            `stat_tracker_terrace` a
        WHERE 1=1
        <if test="sDate != null">
            and track_time &gt;=  #{sDate}
        </if>
        <if test="eDate != null">
            and track_time &lt;=  #{eDate}
        </if>
        <if test="name != null">
            and product_name like concat('%', #{name},'%')
        </if>
        <!-- GROUP BY
            DATE_FORMAT(track_time, '%Y-%m-%d'),
            product_id --> ) t
          ORDER BY
              t.date DESC, t.click_count  DESC
             <if test="iDisplayStart != null and iDisplayLength!=null">
             LIMIT ${iDisplayStart}, ${iDisplayLength}
        </if> 
       
    </select>

    <select id="queryAll" parameterType="map" resultMap="resultMap">
        SELECT
        <include refid="Base_Column_List"></include>
        FROM
        `stat_tracker_terrace` 
        WHERE 1=1
        <if test="sDate != null">
            and track_time &gt;=  #{sDate}
        </if>
        <if test="eDate != null">
            and track_time &lt;=  #{eDate}
        </if>
        <if test="name != null">
            and product_name like concat('%', #{name},'%')
        </if>
        GROUP BY
        DATE_FORMAT(track_time, '%Y-%m-%d'),
        product_id
        ORDER BY
        track_time DESC
    </select>
    
    
     <select id="queryOne" parameterType="map" resultType="Integer">
        SELECT
        1
        FROM
        `stat_tracker_terrace` 
        WHERE 1=1
        limit 1
    </select>

  <!--   <select id="queryMoreClick" parameterType="map"  resultMap="resultMap">
        SELECT
            list_count,
            DATE_FORMAT(track_time, '%Y-%m-%d') AS date
        FROM
            `stat_tracker_terrace`
        WHERE 1=1
          AND page_type_code = 'xulu://more.guanjia.com'
        <if test="sDate != null">
            and DATE_FORMAT(track_time , '%Y-%m-%d') &gt;=  #{sDate}
        </if>
        <if test="eDate != null">
            and DATE_FORMAT(track_time , '%Y-%m-%d') &lt;=  #{eDate}
        </if>
        GROUP BY
            DATE_FORMAT(track_time, '%Y-%m-%d')
    </select> -->
    
    <select id="queryDetail" parameterType="map" resultMap="resultMap">
        SELECT
            a.uid AS phone_num,
            COUNT(
                CASE
                WHEN (a.area_index = 0 OR a.area_index = 1) THEN
                    0
                END
            ) AS total,
            COUNT(
            CASE
            WHEN (a.page_type_code = 'xulu://more.guanjia.com') THEN
            0
            END
            ) AS list_count,
            COUNT(
                CASE
                WHEN a.area_index = 0 THEN
                    0
                END
            ) AS count,
            COUNT(
                CASE
                WHEN a.area_index = 1 THEN
                    0
                END
            ) AS apply_count,
            DATE_FORMAT(
                a.track_time,
                '%Y-%m-%d %H:%i:%s'
            ) AS date
        FROM
            `stat_tracker_terrace` a
        WHERE 1=1
        and  a.area_id =  2
        <if test="id != null">
            and  a.product_id =  #{id}
        </if>
        <if test="date != null">
            and DATE_FORMAT(a.track_time , '%Y-%m-%d') = #{date}
        </if>
        GROUP BY
            a.uid
        ORDER BY total DESC
    </select>

</mapper>
